<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!</title>
  <style>
    :root{ --bg:#0f0f13; --fg:#e9e9ee; --muted:#b7b7c2; --accent:#ff6fa9; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:#0f0f13; color:var(--fg);}
    .wrap{min-height:100vh; display:flex; flex-direction:column; align-items:center;}
    .stage{position:relative;width:100%;height:60vh;max-height:720px;overflow:hidden;background:radial-gradient(1200px 800px at 50% 20%,#1a1a22,var(--bg));}
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    .panel{width:min(720px,92vw); margin:24px auto 16px; padding:18px 20px; background:#16161d; border:1px solid #242433; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h2{margin:0 0 10px; font-size:18px; font-weight:600}
    .panel p{margin:0 0 14px; color:var(--muted)}
    .row{display:flex; gap:10px}
    input[type=text]{flex:1; padding:12px 14px; border-radius:12px; border:1px solid #2a2a3b; background:#0d0d12; color:var(--fg); font-size:16px}
    button{padding:12px 16px; border-radius:12px; border:1px solid #2a2a3b; background:linear-gradient(180deg,#1f1f29,#171720); color:var(--fg); cursor:pointer; font-weight:600}
    .foot{opacity:.6; font-size:12px; text-align:center; margin:20px 0 30px}
    .screen{display:none; min-height:100vh; align-items:center; justify-content:center; padding:40px 20px}
    .screen.active{display:flex}
    .card{width:min(820px,95vw); background:#16161d; border:1px solid #242433; border-radius:18px; padding:36px; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,.4)}
    .audio-ctrl{position:fixed; right:16px; top:16px; display:flex; gap:10px; z-index:10}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid #2a2a3b; background:#14141b; color:#cfcfde; font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:#e05a9b; box-shadow:0 0 10px #e05a9b88}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage" id="stage">
      <canvas id="petals"></canvas>
    </div>

    <div class="panel" id="panel" aria-live="polite">
      <h2>–Ω–∞–ø–æ–º–Ω–∏, –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–±–µ —ç—Ç–æ?</h2>
      <p>–ü–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –æ–¥–Ω–∞-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞, –ø–æ–¥ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω —É —Ç–µ–±—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω üôÇ</p>
      <form class="row" id="answerForm">
        <input id="answer" type="text" placeholder="–≤–≤–µ–¥–∏ —Ñ—Ä–∞–∑—É" autocomplete="off" maxlength="64" />
        <button type="submit">–û–∫</button>
      </form>
      <div class="hint" style="margin-top:8px;color:#8b8b98;font-size:13px">–ù–µ–±–æ–ª—å—à–æ–π –Ω–∞–º—ë–∫: –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ç—Ä–∏ —Å–ª–æ–≤–∞.</div>
    </div>

    <div class="foot">–°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –±—Ä–∞—Ç–æ–º üíú</div>
  </div>

  <section class="screen" id="screen2">
    <div class="card">
      <h1>–í–µ—Ä–Ω–æ! üéâ</h1>
      <p>–Ø –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç–µ–ª —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —Å–≤–µ—Ç–æ–º, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –¥–µ–Ω—å –ø–∞—Å–º—É—Ä–Ω—ã–π ‚ù§Ô∏è</p>
      <div style="margin-top:18px"><button id="restartBtn">–ï—â—ë —Ä–∞–∑</button></div>
    </div>
  </section>

  <div class="audio-ctrl">
    <span class="tag" id="musicState"><span class="dot"></span> –º—É–∑—ã–∫–∞: –≤—ã–∫–ª</span>
    <button id="musicBtn" title="–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É">–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É</button>
  </div>

  <!-- –ü–æ–ª–æ–∂–∏ lofi.mp3 —Ä—è–¥–æ–º —Å index.html -->
  <audio id="bgm" preload="auto" loop playsinline>
    <source src="lofi.mp3" type="audio/mpeg" />
  </audio>

  <script>
  ;(() => {
    const canvas = document.getElementById('petals');
    const ctx = canvas.getContext('2d');
    const stage = document.getElementById('stage');

    const panel = document.getElementById('panel');
    const screen2 = document.getElementById('screen2');
    const form = document.getElementById('answerForm');
    const answer = document.getElementById('answer');
    const restart = document.getElementById('restartBtn');

    const musicBtn = document.getElementById('musicBtn');
    const musicState = document.getElementById('musicState');
    const bgm = document.getElementById('bgm');

    const TEXT = '–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!';

    // ---------- Canvas sizing ----------
    function fit(){
      let w = stage.clientWidth || window.innerWidth;
      let h = stage.clientHeight || Math.floor(window.innerHeight*0.6);
      const dpr = Math.min(devicePixelRatio||1,2);
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    addEventListener('resize', () => { fit(); buildTargets(); });

    // ---------- Particles ----------
    const petals = [];
    let targets = [];
    let forming = false;

    const palette = ['#ffd7e5','#ffc7df','#ffb8d9','#ffa9d3','#ff9acd','#ff8bc7'];
    const MAX = 700;

    const rand = (a,b)=>Math.random()*(b-a)+a;
    const pick = a => a[(Math.random()*a.length)|0];

    function createPetal(y = rand(-stage.clientHeight, 0)){
      const size = rand(5,12);
      return { x: rand(0, stage.clientWidth), y, vx: rand(-0.25,0.25), vy: rand(0.7,1.4),
               wobble: rand(0,Math.PI*2), wobbleSpeed: rand(0.008,0.02),
               rot: rand(0,Math.PI*2), rotSpeed: rand(-0.015,0.015), size,
               color: pick(palette), target:null, alpha:1 };
    }

    function seed(){
      petals.length = 0;
      const base = Math.ceil(stage.clientWidth*stage.clientHeight/2600);
      const cap = innerWidth < 520 ? 280 : 520;
      const need = Math.min(cap, base);
      for (let i=0;i<need;i++) petals.push(createPetal(rand(-stage.clientHeight, stage.clientHeight)));
    }

    function draw(p){
      const s = p.size; ctx.save(); ctx.globalAlpha = p.alpha; ctx.translate(p.x,p.y); ctx.rotate(p.rot + Math.sin(p.wobble)*0.18);
      const g = ctx.createRadialGradient(0,0,1,0,0,s); g.addColorStop(0,'#fff7fa'); g.addColorStop(1,p.color);
      ctx.fillStyle = g; ctx.beginPath(); ctx.moveTo(0,-s*0.2); ctx.bezierCurveTo(s*0.9,-s*0.9,s*0.9,s*0.9,0,s); ctx.bezierCurveTo(-s*0.9,s*0.9,-s*0.9,-s*0.9,0,-s*0.2); ctx.closePath(); ctx.fill(); ctx.restore();
    }

    // ---------- Text targets ----------
    function buildTargets(){
      const w = stage.clientWidth, h = stage.clientHeight;
      const isPhone = innerWidth < 520;
      const scale = isPhone ? 0.42 : 0.58;
      const offW = Math.max(220, Math.floor(w*scale));
      const offH = Math.max(140, Math.floor(h*scale));
      const off = document.createElement('canvas'); off.width=offW; off.height=offH; const c = off.getContext('2d');
      const fs = Math.max(26, Math.min(90, Math.floor(offW*0.2)));
      c.clearRect(0,0,offW,offH); c.fillStyle='#fff'; c.textAlign='center'; c.textBaseline='middle'; c.font=`800 ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Arial`; c.fillText(TEXT, offW/2, offH/2);
      const img = c.getImageData(0,0,offW,offH).data;
      const step = isPhone ? 4 : 3; const pts=[];
      for (let y=0;y<offH;y+=step) for (let x=0;x<offW;x+=step) { const a = img[(y*offW + x)*4 + 3]; if (a>150) pts.push({x:Math.floor(x/scale),y:Math.floor(y/scale)}); }
      const maxPts = isPhone ? 240 : 520;
      targets = pts.length>maxPts ? pts.filter((_,i)=>i%Math.max(1,Math.floor(pts.length/maxPts))===0).slice(0,maxPts) : pts;
      for (let i=targets.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [targets[i],targets[j]]=[targets[j],targets[i]]; }
    }

    // ---------- Animation ----------
    let last = 0;
    function tick(t){
      if (!last) last = t;
      const dt = Math.min(32, t-last); last = t; const s = dt/16.6667;
      ctx.clearRect(0,0,stage.clientWidth,stage.clientHeight);

      if (!forming && petals.length < MAX && Math.random()<0.25) petals.push(createPetal());

      for (const p of petals){
        if (p.target && forming){
          const dx=p.target.x-p.x, dy=p.target.y-p.y, k=0.18;
          p.vx = p.vx*(1-0.18*s) + dx*k*0.02*s;
          p.vy = p.vy*(1-0.18*s) + dy*k*0.02*s;
          p.x += p.vx*s; p.y += p.vy*s;
          p.rot += p.rotSpeed*s; p.wobble += p.wobbleSpeed*s;
        } else {
          p.x += (p.vx + Math.sin(p.wobble)*0.25)*s;
          p.y += p.vy*s;
          p.vy += 0.02*s;
          p.rot += p.rotSpeed*s; p.wobble += p.wobbleSpeed*s;
          if (p.y>stage.clientHeight+24){ p.y=-24; p.x=rand(0,stage.clientWidth); p.vy=rand(0.7,1.4); }
          if (forming) p.alpha*=0.985;
        }
        draw(p);
      }
      requestAnimationFrame(tick);
    }

    function assign(){
      while (petals.length < targets.length) petals.push(createPetal(rand(-stage.clientHeight,0)));
      for (let i=0;i<targets.length;i++){ petals[i].target = targets[i]; petals[i].alpha = 1; }
      forming = true;
    }

    function start(){
      fit(); seed(); buildTargets();
      setTimeout(assign, 2500); // –¥–∞—ë–º ¬´–ø–æ–≤–∞–ª—è—Ç—å —Å–Ω–µ–≥—É¬ª
      requestAnimationFrame(tick);
    }

    // ---------- Answer flow ----------
    const norm = s => (s||'').toLowerCase().trim().replace(/\\s+/g,' ');
    form.addEventListener('submit', e=>{
      e.preventDefault();
      if (norm(answer.value)==='what is love'){
        document.querySelector('.wrap').style.display='none';
        screen2.classList.add('active');
      } else {
        answer.style.borderColor='#e05a9b';
        answer.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:180,iterations:2});
      }
    });
    restart?.addEventListener('click', ()=>{
      screen2.classList.remove('active'); document.querySelector('.wrap').style.display='';
      answer.value=''; answer.style.borderColor=''; forming=false; start();
    });

    // ---------- Audio ----------
    let audioOn=false;
    function ensureFile(){
      if (!bgm.currentSrc) { bgm.src = 'lofi.mp3'; bgm.load(); }
    }
    async function toggleMusic(){
      try{
        ensureFile();
        if (!audioOn){ await bgm.play(); audioOn=true; musicState.innerHTML='<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤–∫–ª'; musicBtn.textContent='–í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É'; }
        else { bgm.pause(); audioOn=false; musicState.innerHTML='<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤—ã–∫–ª'; musicBtn.textContent='–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É'; }
      }catch(e){
        // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ file:// –±—Ä–∞—É–∑–µ—Ä –º–æ–∂–µ—Ç –±–ª–æ—á–∏—Ç—å ‚Äî –ø–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ http-—Å–µ—Ä–≤–µ—Ä
        alert('–ú—É–∑—ã–∫—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: python -m http.server)');
      }
    }
    musicBtn.addEventListener('click', toggleMusic);

    // ---------- Go ----------
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(start, 0);
    } else {
      window.addEventListener('DOMContentLoaded', () => setTimeout(start, 0), { once:true });
    }
  })();
  </script>
</body>
</html>
