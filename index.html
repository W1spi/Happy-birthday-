<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!</title>
  <style>
    :root{
      --bg:#0f0f13;
      --fg:#e9e9ee;
      --muted:#b7b7c2;
      --accent:#ff6fa9;
      --accent-2:#ffc1d9;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Inter", Arial, sans-serif; background: radial-gradient(1200px 800px at 50% 20%, #1a1a22, var(--bg)); color:var(--fg); overflow-x:hidden}
    .wrap{min-height:100vh; display:flex; flex-direction:column; align-items:center;}

    /* Stage area */
    .stage{position:relative; width:100%; height:60vh; max-height:720px; overflow:hidden}
    canvas#petals{position:absolute; inset:0; width:100%; height:100%; display:block}

    .title-overlay{display:none !important}
    .fade-in{animation:fadeIn .9s ease forwards}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    /* Prompt / input */
    .panel{width:min(720px, 92vw); margin:24px auto 16px; padding:18px 20px; background:#16161d; border:1px solid #242433; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel h2{margin:0 0 10px; font-size:18px; font-weight:600; color:var(--fg)}
    .panel p{margin:0 0 14px; color:var(--muted)}
    .row{display:flex; gap:10px}
    input[type="text"]{flex:1; padding:12px 14px; border-radius:12px; border:1px solid #2a2a3b; background:#0d0d12; color:var(--fg); font-size:16px}
    input[type="text"]::placeholder{color:#6a6a79}
    button{padding:12px 16px; border-radius:12px; border:1px solid #2a2a3b; background:linear-gradient(180deg, #1f1f29, #171720); color:var(--fg); cursor:pointer; font-weight:600}
    button:hover{filter:brightness(1.1)}

    .hint{margin-top:8px; font-size:13px; color:#8b8b98}

    /* Second screen */
    .screen{display:none; min-height:100vh; align-items:center; justify-content:center; padding:40px 20px}
    .screen.active{display:flex}
    .card{width:min(820px,95vw); background:#16161d; border:1px solid #242433; border-radius:18px; padding:36px; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,.4)}
    .card h1{font-size:28px; margin:0 0 10px}
    .card p{font-size:18px; color:var(--muted)}

    /* Audio button */
    .audio-ctrl{position:fixed; right:16px; top:16px; display:flex; gap:10px}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid #2a2a3b; background:#14141b; color:#cfcfde; font-size:12px}
    .dot{width:8px;height:8px;border-radius:50%;background:#e05a9b; box-shadow:0 0 10px #e05a9b88}

    .foot{opacity:.6; font-size:12px; text-align:center; margin:20px 0 30px}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage" id="stage">
      <canvas id="petals"></canvas>
      <!-- Optional overlay text while forming -->
      
    </div>

    <div class="panel" id="panel" aria-live="polite">
      <h2>–Ω–∞–ø–æ–º–Ω–∏, –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–±–µ —ç—Ç–æ?</h2>
      <p>–ü–æ–¥—Å–∫–∞–∑–∫–∞: —ç—Ç–æ –æ–¥–Ω–∞-–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ—Ä–∞–∑–∞, –ø–æ–¥ –∫–æ—Ç–æ—Ä–æ–π –æ–Ω —É —Ç–µ–±—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω üôÇ</p>
      <form class="row" id="answerForm">
        <input id="answer" type="text" placeholder="–≤–≤–µ–¥–∏ —Ñ—Ä–∞–∑—É" autocomplete="off" maxlength="64" />
        <button type="submit" title="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å">–û–∫</button>
      </form>
      <div class="hint">–ù–µ–±–æ–ª—å—à–æ–π –Ω–∞–º—ë–∫: –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ç—Ä–∏ —Å–ª–æ–≤–∞.</div>
    </div>

    <div class="foot">–°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –±—Ä–∞—Ç–æ–º üíú</div>
  </div>

  <!-- Success screen -->
  <section class="screen" id="screen2">
    <div class="card fade-in">
      <h1>–í–µ—Ä–Ω–æ! üéâ</h1>
      <p>–Ø –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç–µ–ª —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —Å–≤–µ—Ç–æ–º, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –¥–µ–Ω—å –ø–∞—Å–º—É—Ä–Ω—ã–π ‚ù§Ô∏è</p>
      <div style="margin-top:18px">
        <button id="restartBtn">–ï—â—ë —Ä–∞–∑</button>
      </div>
    </div>
  </section>

  <!-- Background music (provide your own lofi.mp3 or keep off) -->
  <audio id="bgm" preload="auto" loop>
    <source src="lofi.mp3" type="audio/mpeg" />
  </audio>

  <div class="audio-ctrl">
    <span class="tag" id="musicState"><span class="dot"></span> –º—É–∑—ã–∫–∞: –≤—ã–∫–ª</span>
    <button id="musicBtn" title="–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É">–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É</button>
  </div>

  <script>
  ;(() => {
    const CANVAS = document.getElementById('petals');
    const CTX = CANVAS.getContext('2d');
    const OVERLAY = null; // overlay removed
    const PANEL = document.getElementById('panel');
    const SCREEN2 = document.getElementById('screen2');
    const ANSWER = document.getElementById('answer');
    const FORM = document.getElementById('answerForm');
    const MUSIC_BTN = document.getElementById('musicBtn');
    const MUSIC_STATE = document.getElementById('musicState');
    const BGM = document.getElementById('bgm');
    const RESTART = document.getElementById('restartBtn');

    // ensure audio element points to local file when available
    if (!BGM.querySelector('source')){
      BGM.src = 'lofi.mp3';
    }
    BGM.preload = 'auto';
    BGM.load();

    const TARGET_TEXT = '–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!';
    const stage = document.getElementById('stage');

    // Resize canvas
    function fit() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      CANVAS.width = Math.floor(stage.clientWidth * dpr);
      CANVAS.height = Math.floor(stage.clientHeight * dpr);
      CANVAS.style.width = stage.clientWidth + 'px';
      CANVAS.style.height = stage.clientHeight + 'px';
      CTX.setTransform(dpr, 0, 0, dpr, 0, 0);
      buildTextTargets();
    }
    window.addEventListener('resize', fit);

    // Particles (petals)
    const petals = [];
    const MAX = Math.min((stage.clientWidth<520?420:800), Math.ceil(stage.clientWidth*stage.clientHeight/2800));
    const palette = [ '#ffd7e5', '#ffc7df', '#ffb8d9', '#ffa9d3', '#ff9acd', '#ff8bc7' ];

    function rand(a,b){return Math.random()*(b-a)+a}
    function pick(arr){return arr[(Math.random()*arr.length)|0]}

    function createPetal(yStart = rand(-stage.clientHeight, 0)){
      const size = rand(5, 12);
      return {
        x: rand(0, stage.clientWidth),
        y: yStart,
        vx: rand(-0.25, 0.25),
        vy: rand(0.7, 1.4), // px per frame baseline
        wobble: rand(0, Math.PI*2),
        wobbleSpeed: rand(0.008, 0.02),
        rot: rand(0, Math.PI*2),
        rotSpeed: rand(-0.015, 0.015),
        size,
        color: pick(palette),
        target: null,
        arriveT: 0,
        alpha: 1
      }
    }
    }
    }

    // init
    fit();
    seedPetals();
    buildTextTargets();
    orchestrate();
    requestAnimationFrame(tick);
    }

    function seedPetals(){
      petals.splice(0, petals.length);
      const base = Math.ceil(stage.clientWidth*stage.clientHeight/2200);
      const cap = (stage.clientWidth < 520 ? 380 : 750);
      const need = Math.min(cap, base);
      for (let i=0;i<need;i++) petals.push(createPetal(rand(-stage.clientHeight, stage.clientHeight)));
    }

    // init
    fit();
    seedPetals();
    buildTextTargets();
    orchestrate();
    requestAnimationFrame(tick);
    }

    // Orchestrate timeline
    function orchestrate(){
      formed = false; forming = false;
      // start forming after a pause so enough petals exist
      setTimeout(() => {
        assignTargets();
        setTimeout(()=>{ formed = true; }, 4500);
      }, 2500);
      setTimeout(() => { PANEL.classList.add('fade-in'); ANSWER.focus(); }, 5200);
    }, 4500);
      }, 3200);
      // reveal the panel slightly later
      setTimeout(() => {
        PANEL.classList.add('fade-in'); ANSWER.focus();
      }, 5200);
    }

    // Answer logic
    function normalize(s){return (s||'').toLowerCase().trim().replace(/\s+/g,' ')}

    FORM.addEventListener('submit', (e) => {
      e.preventDefault();
      const ok = normalize(ANSWER.value) === 'what is love';
      if (ok){
        // transition to screen 2
        document.querySelector('.wrap').style.display = 'none';
        SCREEN2.classList.add('active');
      } else {
        ANSWER.style.borderColor = '#e05a9b';
        ANSWER.animate([
          { transform:'translateX(0)' },
          { transform:'translateX(-6px)' },
          { transform:'translateX(6px)' },
          { transform:'translateX(0)' }
        ], { duration:180, iterations:2 });
      }
    });

    RESTART?.addEventListener('click', () => {
      SCREEN2.classList.remove('active');
      document.querySelector('.wrap').style.display = '';
      ANSWER.value=''; ANSWER.style.borderColor='';
      fit();
      seedPetals();
      buildTextTargets();
      forming = false; formed = false;
      orchestrate();
    });
      document.querySelector('.wrap').style.display = '';
      ANSWER.value='';
      ANSWER.style.borderColor='';
      petals.splice(0, petals.length);
      for (let i=0;i<Math.min(MAX, Math.ceil(stage.clientWidth*stage.clientHeight/1600));i++) {
        petals.push(createPetal(rand(-stage.clientHeight, stage.clientHeight)));
      }
      fit();
      orchestrate();
    });

    // Audio control (requires user gesture)
    let audioOn = false;
    async function toggleMusic(){
      try{
        if (!audioOn){
          // ensure a user gesture triggered this
          if (BGM.readyState < 2){ BGM.load(); }
          BGM.currentTime = 0;
          await BGM.play();
          audioOn = true; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤–∫–ª';
          MUSIC_BTN.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
        } else {
          if (!BGM.paused) BGM.pause();
          if (audioCtx && audioCtx.state !== 'closed') { audioCtx.suspend(); }
          audioOn = false; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤—ã–∫–ª';
          MUSIC_BTN.textContent = '–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
        }
      }catch(err){
        console.warn('Audio error', err);
        // fallback to WebAudio pad after a gesture
        if (!audioCtx) { startWebAudioLofi(); audioOn = true; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤–∫–ª'; MUSIC_BTN.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É'; }
      }
    } else {
            startWebAudioLofi();
          }
          audioOn = true; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤–∫–ª';
          MUSIC_BTN.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
        } else {
          if (audioCtx && audioCtx.state !== 'closed') { audioCtx.suspend(); }
          if (!BGM.paused) BGM.pause();
          audioOn = false; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤—ã–∫–ª';
          MUSIC_BTN.textContent = '–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
        }
      }catch(err){ console.warn('Audio error', err); }
    } else {
            await BGM.play();
          }
          audioOn = true; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤–∫–ª';
          MUSIC_BTN.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
        } else {
          if (audioCtx){ audioCtx.suspend(); }
          BGM.pause();
          audioOn = false; MUSIC_STATE.innerHTML = '<span class="dot"></span> –º—É–∑—ã–∫–∞: –≤—ã–∫–ª';
          MUSIC_BTN.textContent = '–í–∫–ª—é—á–∏—Ç—å –º—É–∑—ã–∫—É';
        }
      }catch(err){
        console.warn('Audio play blocked or failed:', err);
      }
    }
    MUSIC_BTN.addEventListener('click', toggleMusic);
    // iOS unlock
    window.addEventListener('touchstart', () => {
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }, { once:true });

    // Minimal WebAudio fallback: gentle lo-fi pad
    let audioCtx; let gNodes=[];
    function startWebAudioLofi(){
      if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); return; }
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const master = audioCtx.createGain(); master.gain.value = 0.05; master.connect(audioCtx.destination);

      function makePad(freq){
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        g.gain.value = 0.0001;
        o.connect(g).connect(master);
        o.start();
        const now = audioCtx.currentTime;
        g.gain.cancelScheduledValues(now);
        g.gain.linearRampToValueAtTime(0.08, now+2+Math.random()*2);
        function modulate(){
          const t = audioCtx.currentTime;
          g.gain.linearRampToValueAtTime(0.03+Math.random()*0.08, t+3);
          setTimeout(modulate, 3000);
        }
        modulate();
        return {o,g};
      }
      const base = 220;
      gNodes = [ makePad(base), makePad(base*1.25), makePad(base*1.5) ];
    }
    }

    // init
    fit();
    buildTextTargets();
    orchestrate();
    requestAnimationFrame(tick);
  })();
  </script>
</body>
</html>
